<!DOCTYPE html><html><head> <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png"><link rel="manifest" href="/icons/site.webmanifest"><link rel="shortcut icon" href="/icons/favicon.ico"><meta name="msapplication-TileColor" content="#603cba"><meta name="msapplication-config" content="/icons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="google-site-verification" content="--WV6qAuzU9GnL3462uvvFCGbyR8jm9J0YzYWMWQ1IU"><title>Configuration &amp; Options â€¢ joshsj</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous"><link rel="stylesheet" href="/styles/variables.css"><link rel="stylesheet" href="/styles/utilities.css"><link rel="stylesheet" href="/styles/base.css"><link rel="stylesheet" href="/styles/layout.css"><link rel="stylesheet" href="/styles/components.css"><link rel="stylesheet" href="/styles/lib.css"><script src="/scripts/theme.js" defer></script><script src="/scripts/myEmail.js" defer></script><script src="/scripts/id-jumper.js" defer></script><script src="/scripts/konami.js" defer></script></head><body>   <nav><a href="/">Home</a><a href="/blog/">Blog</a><a href="/collections/">Collections</a><a href="/portfolio/">Portfolio</a><button class="link" id="theme-toggle" aria-hidden="" aria-role="Toggle for light/dark theme"></button></nav><main class="content"><h1>Configuration &amp; Options</h1><p>Posted on August 21st, 2022</p><p class="squish">Part of <a href="/collections/"> Notes on .NET</a></p><p class="squish sep sep-pop"><span class="skip">Talks about</span><span>C#</span><span>.NET</span></p><p>Configuration functionality comes from the <code>Microsoft.Extensions.Configuration</code> package.<!-- more-->Data is accessed using key-value pairs; nested keys are separated with colons (e.g., <code>Section1:Key1</code>).</p><p>Simple access to keys and values uses get methods:</p><figure><div class="inner"><pre><code class="prism"><span class="token class-name">IConfiguration</span> config <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token comment">// Value access</span>
config<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetValue</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token string">"SomeBool"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Nested values</span>
config<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetValue</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token string">"NestedBool:AnotherBool"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Section scope</span>
<span class="token class-name"><span class="token keyword">var</span></span> faveDrinks <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"Favourites:Drinks"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> faveHotDrink <span class="token operator">=</span> faveDrinks<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetValue</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token string">"Hot"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div><figcaption>Basic configuration access</figcaption></figure><p>Storing connection strings under the <code>ConnectionStrings</code> key is a common pattern;
<code>GetConnectionString(cs)</code> method automatically checks for a string under the
<code>ConnectionStrings</code> key.</p><h2>Configuration Sources</h2><p><code>appsettings.json</code> is the default configuration file used by .NET.Environment-specific
files can override the base config file; e.g., <code>appsettings.Development.json</code>
or <code>appsettings.Staging.json</code>.</p><p>Similarly, Visual Studio has a  <code>launchSettings.json</code> which uses
<code>__</code> as its hierarchy spacer.</p><p>Environment variables can overwrite values further: <code>$Favourites__Food=Banana</code>.</p><p>Finally, command-line arguments can also be used:<code>$ dotnet run --Favourites:Food Banana</code></p><h2>Security</h2><p>Storing secure data in files is bad as they either live in source control or on
deployment platforms. Dotnet provides <code>user-secrets</code> to store secure data at
development-time instead: <code>$ dotnet user-secrets set "Favourites:Food" "Banana"</code>.</p><p>For production, Azure Key Vault can be implemented with the
<code>Microsoft.Azure.Services.AppAuthentication</code> and
<code>Microsoft.Extensions.Configuration.AzureKeyVault</code> packages.</p><h2>Options Pattern</h2><p>Although <code>IConfiguration</code> <em>can</em> be injected, using getters with magic
string/static constant strings isn't ideal. The Options pattern is much cleaner
and robust, using models matching the structure of configuration data.</p><figure><div class="inner"><pre><code class="prism"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthOptions</span>
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token return-type class-name">TimeSpan</span> CookieLifeTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Configure</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>AuthOptions<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"Auth"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div><figcaption>Basic Options registration</figcaption></figure><h2>Live Updates</h2><p>The standard <code>Configure</code> method registers a singleton. Alternatively, the
<code>IOptionsSnapshot<></code> interface registers configs as scoped dependencies which
provides the latest configuration data on construction.</p><p>For the latest data every time, use the <code>CurrentValue</code> property offered by <code>IOptionsMonitor<></code>.</p><h2>Validation</h2><p>The extension method <code>ValidateDataAnnotations()</code> can validate configuration files
against attributes like <code>[Required]</code>.</p><p><strong>Note:</strong> validation is triggered on the first access to the object, not on creation,
so be smart when using this.</p></main></body></html>